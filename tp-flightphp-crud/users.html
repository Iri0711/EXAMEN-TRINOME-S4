<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Gestion des Prêts Bancaires</title>
   
     <link rel="stylesheet" href="assets/css/general.css">
     <link rel="stylesheet" href="assets/css/index.css">
     <link rel="stylesheet" href="assets/css/formes.css">
     <link rel="stylesheet" href="assets/css/carte.css">
     <link rel="stylesheet" href="assets/css/tables.css">
     <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

</head>
<body>
    <div class="main-container">
        <div class="menu">
            <div class="logo"><img src="assets/images/Flux_Dev_A_modern_highcontrast_transparent_background_logo_des_2-removebg-preview.png" alt="Logo Banque"></div>
            <nav>
                <ul>
                    <li>
                        <button class="dropdown-btn" >Dashboard</button>
                        <ul class="dropdown-content">
                            <li><a href="index.html">Interets</a></li>
                        </ul>
                    </li>
                    <li>
                        <button class="dropdown-btn">Finance</button>
                        <ul class="dropdown-content">
                             <li><a href="fond.html">Fonds</a></li>
                            <li><a href="prets.html">Prets</a></li>
                            
                        </ul>
                    </li>
                    <li>
                        <button class="dropdown-btn">Crud</button>
                        <ul class="dropdown-content">
                            <li><a href="users.html">User</a></li>
                            <li><a href="departements.html">Departement</a></li>
                        </ul>
                    </li>
                    <li>
                        <button class="dropdown-btn">Autre fonctions</button>
                        <ul class="dropdown-content">
                            <li><a href="simulation.html">Simulation</a></li>
                        </ul>
                    </li>
                </ul>
            </nav>
        </div>
        <div class="content">
             <div class="full table">
                <div class="full search">
                        <div class="title">
                            <span>Listes des utilisateurs</span>
                        </div>
                        <div class="input">
                            <a onclick="myModal()" class="validate">Ajouter</a>
                        </div>
                        
                </div> 
                <div class="full table-content">
                        <table>
                            <thead>
                                <tr>
                                    <th>Nom</th>
                                    <th>Prenom</th>
                                    <th>Contact</th>
                                    <th>Email</th>
                                    
                                    <th>
                                        Action
                                    </th>
                                </tr>
                            </thead>
                            <tbody>
                                

                                
                                
                            </tbody>
                        </table>
                </div>
                <div class="table-footer">
                       
                </div>
                <div class="form" id="form">
                    <a onclick="fermer()" class="close"><img src="assets/images/close_100dp_000000_FILL0_wght400_GRAD0_opsz48.png" alt="" srcset=""></a>
                    <div class="formulaire">
                        <div class="formulaire-header">
                            Formulaire d'ajout d'utilisateur
                        </div>
                        <div class="formulaire-content">
                            <!-- Partie 1: Identité -->
                            <fieldset class="form-section" id="section-identite">
                                <legend>Informations personnelles</legend>
                                <div class="element">
                                    <input type="text" name="nom" id="nom" placeholder=" " required>
                                    <label for="nom">Nom</label>
                                </div>
                                <div class="element">
                                    <input type="text" name="prenom" id="prenom" placeholder=" " required>
                                    <label for="prenom">Prénom</label>
                                </div>
                                <div class="element">
                                    <input type="text" name="contact" id="contact" placeholder=" ">
                                    <label for="contact">Contact</label>
                                </div>
                            </fieldset>

                            <!-- Partie 2: Authentification -->
                            <fieldset class="form-section" id="section-auth" style="display:none;">
                                <legend>Informations d'authentification</legend>
                                <div class="element">
                                    <input type="email" name="email" id="email" placeholder=" ">
                                    <label for="email">Email</label>
                                </div>
                                <div class="element">
                                    <input type="password" name="mdp" id="mdp" placeholder=" " required>
                                    <label for="mdp">Mot de passe</label>
                                </div>
                                <div class="element">
                                    <input type="password" name="confirm_mdp" id="confirm_mdp" placeholder=" " required>
                                    <label for="confirm_mdp">Confirmer le mot de passe</label>
                                </div>
                            </fieldset>
                        </div>
                        <div class="formulaire-footer">
                            <button type="button" class="btn-prev validate" onclick="prevSection()" style="display:none;">Précédent</button>
                            <button type="button" class="btn-next validate" onclick="nextSection()">Suivant</button>
                            <button type="button" class="btn-submit validate" onclick="submitForm()" style="display:none;">Valider</button>
                        </div>
                    </div>
                </div>
                
                
        
        </div>
    </div>
    <script src="assets/js/admin_index.js"></script>
    <script src="assets/js/formes.js"></script>
    <script src="assets/js/ajax.js"></script><script>
    // Fonctions pour la navigation entre sections
    var id = -1;
    
    window.addEventListener('DOMContentLoaded', () => {
        loadUsersData();
    });

    // Fonction pour charger les données des utilisateurs et créer la table
    function loadUsersData() {
        ajax('GET', `/users`, null, (response) => {
            if (response?.success && response?.data?.length) {
                createUsersTable(response.data);
                setupActionButtons();
            } else {
                console.error("Données manquantes", response);
                displayTableMessage('Aucun utilisateur trouvé');
            }
        }, (error) => {
            console.error("Erreur:", error);
            displayTableMessage('Erreur de chargement des données');
        });
    }

    // Fonction pour créer la table des utilisateurs
    function createUsersTable(usersData) {
        // Mise à jour du titre
        document.querySelector('.full.table .title span').textContent = "Liste des utilisateurs";
        
        // Remplissage des données
        const tableContent = document.querySelector('.full.table-content tbody');
        tableContent.innerHTML = ''; // Vider le contenu existant
        
        usersData.forEach((user) => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td style='display:none;'>${user.id || ''}</td>
                <td>${user.nom || ''}</td>
                <td>${user.prenom || ''}</td>
                <td>${user.contact || ''}</td>
                <td><center>${user.email || ''}</center></td>
                <td>
                    <a href="#" class="modify">Modifier</a>
                    <a href="#" class="delete">Supprimer</a>
                </td>
            `;
            tableContent.appendChild(row);
        });
    }

    // Fonction pour afficher un message dans la table
    function displayTableMessage(message) {
        const tableContent = document.querySelector('.full.table-content tbody');
        tableContent.innerHTML = `<tr><td colspan="5" style="text-align: center;">${message}</td></tr>`;
    }

    // Fonction pour gérer les actions des boutons
    function setupActionButtons() {
        document.querySelectorAll('.modify').forEach(btn => {
            btn.addEventListener('click', (e) => {
                e.preventDefault();
                const row = e.target.closest('tr');
                fillFormWithUserData(row);
                myModal();
            });
        });
        
        document.querySelectorAll('.delete').forEach(btn => {
            btn.addEventListener('click', (e) => {
                e.preventDefault();
                if(confirm("Voulez-vous vraiment supprimer cet utilisateur ?")) {
                    const userId = e.target.closest('tr').cells[0].textContent;
                    deleteUser(userId);
                }
            });
        });
    }

    // Fonction pour remplir le formulaire avec les données utilisateur
    function fillFormWithUserData(row) {
        id = row.cells[0].textContent;
        document.getElementById('nom').value = row.cells[1].textContent;
        document.getElementById('prenom').value = row.cells[2].textContent;
        document.getElementById('contact').value = row.cells[3].textContent;
        document.getElementById('email').value = row.cells[4].textContent.trim();
        
        // Cacher les sections non nécessaires pour la modification
        document.getElementById('section-auth').style.display = 'none';
        document.querySelector('.btn-next').style.display = 'none';
        document.querySelector('.btn-submit').style.display = 'block';
    }

    // Fonction pour supprimer un utilisateur
    function deleteUser(userId) {
        ajax('DELETE', `/users/${userId}`, null, (response) => {
            if(response.success) {
                alert("Utilisateur supprimé avec succès");
                loadUsersData(); // Recharger les données au lieu de recharger toute la page
            } else {
                alert("Erreur lors de la suppression");
            }
        });
    }

    function nextSection() {
        document.getElementById('section-identite').style.display = 'none';
        document.getElementById('section-auth').style.display = 'flex';
        document.querySelector('.btn-prev').style.display = 'inline-block';
        document.querySelector('.btn-next').style.display = 'none';
        document.querySelector('.btn-submit').style.display = 'inline-block';
    }

    function prevSection() {
        document.getElementById('section-identite').style.display = 'flex';
        document.getElementById('section-auth').style.display = 'none';
        document.querySelector('.btn-prev').style.display = 'none';
        document.querySelector('.btn-next').style.display = 'inline-block';
        document.querySelector('.btn-submit').style.display = 'none';
    }

    function submitForm() {
        // Validation des champs
        const nom = document.getElementById('nom').value;
        const prenom = document.getElementById('prenom').value;
        const contact = document.getElementById('contact').value;
        const email = document.getElementById('email').value;
        const mdp = document.getElementById('mdp').value;
        const confirmMdp = document.getElementById('confirm_mdp').value;
        
        if (!nom || !prenom) {
            alert('Veuillez remplir tous les champs obligatoires de la section Identité');
            prevSection();
            return;
        }
        
        if (!email || !mdp || !confirmMdp) {
            alert('Veuillez remplir tous les champs obligatoires de la section Authentification');
            return;
        }
        
        if (mdp !== confirmMdp) {
            alert('Les mots de passe ne correspondent pas');
            return;
        }

        if(id == -1) {
            ajax('POST', `/users`, {nom:nom, prenom:prenom, contact:contact, email:email, mdp:mdp}, (response) => {
                if (response?.success) {
                    alert(response?.message);
                    loadUsersData(); // Recharger les données après ajout
                } else {
                    alert("Erreur lors de l'ajout");
                }
            });
        } else {
            ajax('PUT', `/users/${id}`, {nom:nom, prenom:prenom, contact:contact, email:email, mdp:mdp}, (response) => {
                if (response?.success) {
                    alert(response?.message);
                    loadUsersData(); // Recharger les données après modification
                } else {
                    alert("Erreur lors de la modification");
                }
            });
        }
        
        fermer();
        id = -1;
        document.querySelector('form').reset();
    }

    function myModal() {
        var form = document.getElementById("form");
        form.style.display = "flex";
        // Réinitialiser l'affichage des sections
        document.getElementById('section-identite').style.display = 'flex';
        document.getElementById('section-auth').style.display = 'none';
        document.querySelector('.btn-prev').style.display = 'none';
        document.querySelector('.btn-next').style.display = 'inline-block';
        document.querySelector('.btn-submit').style.display = 'none';
    };
    
    function fermer() {
        var form = document.getElementById("form");
        form.style.display = "none";
    };
</script>
    

</body>
</html>