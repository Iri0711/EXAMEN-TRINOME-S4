<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Gestion des fonds</title>
</head>
<body>
    <h1>Gestion des fonds</h1>

    <form action="">
        <!-- <label for="fund-id-etab">ID Établissement:</label> -->
        <input type="number" id="fund-id-etab" name="id_etab" value="1" required hidden>
        <label for="fund-montant">Montant:</label>
        <input type="number" id="fund-montant" name="montant" step="0.01" required>
        <label for="fund-date">Date:</label>
        <input type="date" id="fund-date" name="date" required>
        <label for="fund-name">Libelle:</label>
        <input type="text" id="fund-name" name="libelle" required>
        <button type="submit">Ajouter</button>
    </form>

    <h2>Liste des fonds</h2>
    <table id="funds-list" border="1px">
        <thead>
            <tr>
                <th>ID</th>
                <th>Id etablissement</th>
                <th>Montant</th>
                <th>Date</th>
                <th>Libelle</th>
                <th>Status</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            <!-- Les données seront insérées ici par JavaScript -->
        </tbody>
    </table>

    <h2>Listes des fonds valides</h2>
    <table id="valid-funds-list" border="1px">
        <thead>
            <tr>
                <th>ID</th>
                <th>Id fond</th>
                <th>Montant</th>
                <th>Status</th>
                <th>Date</th>
            </tr>
        </thead>
        <tbody>
            <!-- Les données seront insérées ici par JavaScript -->
        </tbody>
    <script>
       const apiBase = "http://localhost/L2/S4/Mr_Rojo/EXAMEN-TRINOME-S4/tp-flightphp-crud/ws";

        function ajax(method, url, data, callback) {
            const xhr = new XMLHttpRequest();
            xhr.open(method, apiBase + url, true);
            xhr.setRequestHeader("Content-Type", "application/json");

            xhr.onreadystatechange = () => {
                if (xhr.readyState === 4) {
                    if (xhr.status >= 200 && xhr.status < 300) {
                        try {
                            callback(JSON.parse(xhr.responseText));
                        } catch (e) {
                            console.error("Erreur de parsing JSON:", e);
                            console.error("Réponse brute:", xhr.responseText);
                        }
                    } else {
                        console.error(`Erreur HTTP ${xhr.status}: ${xhr.statusText}`);
                        console.error("Réponse brute:", xhr.responseText);
                    }
                }
            };

            const sendData = data ? JSON.stringify(data) : null;
            xhr.send(sendData);
        }

        function loadFunds() {
            console.log("Chargement des fonds...");
            ajax('GET', '/etablissementFonds', null, (data) => {
                console.log("Données reçues:", data);
                const fundsList = document.querySelector('#funds-list tbody');
                fundsList.innerHTML = '';
                if (data.length === 0) {
                    fundsList.textContent = 'Aucun fonds trouvé.';
                    return;
                }
                data.forEach(fund => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${fund.id}</td>
                        <td>${fund.id_etab}</td>
                        <td>${fund.montant}</td>
                        <td>${fund.date}</td>
                        <td>${fund.libelle}</td>
                        <td>En cours</td>
                        <td><button onclick="validerFonds(${fund.id}, '${fund.date}')">Valider</button></td>
                    `;
                    fundsList.appendChild(tr);
                });
            });
        }

        function loadValidFunds() {
            console.log("Chargement des fonds valides...");
            ajax('GET', '/fondValidation', null, (data) => {
                console.log("Données reçues:", data);
                const validFundsList = document.querySelector('#valid-funds-list tbody');
                validFundsList.innerHTML = '';
                if (data.length === 0) {
                    validFundsList.textContent = 'Aucun fonds valide trouvé.';
                    return;
                }
                data.forEach(fund => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${fund.id}</td>
                        <td>${fund.id_etab_fond}</td>
                        <td>${fund.montant}</td>
                        <td>Valide</td>
                        <td>${fund.date}</td>
                    `;
                    validFundsList.appendChild(tr);
                });
            });
        }

        function validerFonds(id,daty) {
            alert('VOULEZ VOUS VALIDER CE FOND ?')
            console.log("Validation du fonds avec ID:", id);
            ajax('POST', '/fondValidation', { id_etab_fond: id , date:daty }, (response) => {
                console.log("Fonds validé:", response);
                loadFunds();
                loadValidFunds();
            });
        } 

        document.querySelector('form').addEventListener('submit', function(event) {
            event.preventDefault();
            const idEtab = document.getElementById('fund-id-etab').value;
            const montant = document.getElementById('fund-montant').value;
            const date = document.getElementById('fund-date').value;
            const libelle = document.getElementById('fund-name').value;

            ajax('POST', '/etablissementFonds', { id_etab: idEtab, montant, date, libelle }, (response) => {
                console.log("Fonds ajouté:", response);
                loadFunds();
                this.reset();
            });
        });

        loadFunds();
        loadValidFunds();
    </script>
</body>
</html>